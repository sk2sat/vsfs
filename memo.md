# Very Simple File System

http://pages.cs.wisc.edu/~remzi/OSTEP/file-implementation.pdf

- ディスクをブロックに分割する
- ブロックのサイズは4KB
- ブロックは0からN-1まである(N個)
- 64ブロック

- ほとんどの領域はユーザデータ
- ユーザデータ用の領域をデータ領域と呼ぶ
- 簡単のため，64ブロックのうち最後の56ブロック(8〜63)をデータ領域とする

- ファイルシステムは各ファイルの情報を追跡する必要がある

## メタデータ
- データ領域内のどのデータブロックがファイルを含むか
- ファイルのサイズ，所有者，アクセス権，アクセス・変更時刻

これらの情報を保存するため，inodeと呼ばれる構造を持つ．
inodeのためのスペースをinode tableと呼び，これはinodeの単純な配列になっている．

ここでは5個のブロック(3〜7)をinode tableとする．
inodeは典型的に，それほど大きくなく，128byteもしくは256byte．
inodeを256byteと仮定すると，4KBのブロックは16個のinodeを保持できる．
今回はinode tableがブロック5個分なので，合計80個のinodeを保持できる(これは使用できるファイルの最大数)．
しかし，より大きなディスク上であれば，このファイルシステムでもより大きなinode tableを作り，より多くのファイル数に対応可能．  

ブロックがinode tableとデータ領域に分けられたが，
これらの他に，inodeやデータ領域が確保されているか，
それとも空き領域かを判定する方法が必要(これはどのようなファイルシステムにおいても必須)．
この方法には色々なものがあり，例えばフリーリストなどがある．
今回は代わりに，シンプルなビットマップを使用する．
1つはデータ領域のための(data bitmap)，もう1つはinode tableのためのもの(inode bitmap)．
ブロック1がinode bitmap，ブロック2がdata bitmap．
ビットマップは単純な構造で，各ビットは対応するオブジェクトもしくはブロックが空き(0)か使用中(1)かを表す．
これらのビットマップに4KBのブロック全体を使用するのは非効率だが，単純のため．


まだブロックが1つ残っている(ブロック0)が残っているが，これはスーパーブロックのために予約されている．
スーパーブロックにはこの特定のファイルシステムに関する情報が含まれる．
例えば，いくつのinodeとデータブロックがファイルシステムにあるか(今回の場合，それぞれ80と56)，
inode tableが開始する場所(ブロック3)，
ファイルシステムの種類(今回はvsfs)を特定するためのマジックナンバーなどが含まれている．
スーパーブロックは，オペレーティングシステムがファイルシステムをマウントする際に最初に読み込まる．

## inode
inode: index node  

各inodeは暗黙のうちにinode番号と呼ばれる．
vsfsなどの単純なファイルシステムでは，inode番号が与えられると，対応するinodeがディスク上のどこにあるかを直接計算できる．
例えば，20KB(inode80個)のinode tableを考える．
さらに，inode領域が12KBから始まる(スーパーブロックが0KB，inode bitmapが4KB，data bitmapが8KBから始まる)と仮定する．


inode番号32を読もうとすると，ファイルシステムは最初に
inode領域へのオフセット(32 * sizeof(inode) = 8192)を計算し，
それをディスク上のinode tableの開始アドレス(12KB)に加算して，目的のinodeブロックの正しいアドレス(20KB)になる．
しかし，実際にはディスクにアクセスできる単位は512byteなので，
inode32をフェッチする際は20 * 1024 / 512 = 40番目のセクタをフェッチする．
より一般的には，inodeブロックのセクタアドレスiaddrは以下のように計算することができる．

```
blk	= (inumber * sizeof(inode_t)) / blockSize;
	  (32      * 256)             / 4KB(4096)
sector	= ((blk * blockSize) + inodeStartAddr) / sectorSize;
	= ((blk * 4KB(4096)) + 12KB          ) / 512;
	= (8192 + 12KB) / 512;
	= 16 + 12KB/512;
	= 16 + 24;
	= 40;
```


各inodeの中には，ファイルに関する必要な全ての情報がある．
そのタイプ(通常のファイル，ディレクトリなど)，そのサイズ，確保されているブロック数，
保護情報(誰がファイルを所有しているか，誰がそれにアクセスできるか)，
時間情報(ファイルが作成，変更，または最後にアクセスされた時)，
及びそのデータブロックがディスク上のどこに存在するかに関する情報(ある種のポインタ)を含む．

我々はこのようなファイルに関する情報をメタデータとして参照する．


inodeの設計において，データブロックがどこにあるかを参照する方法が重要．
簡単なものとしては，ポインタ(ディスクアドレス)を直接inode内に格納するものがある．
この方法には限界があり，とても大きなファイルは使用できない．
